---
  - name: Copy compiled files
    become: true
    unarchive:
      src:  /home/circleci/project/bookingapp.tar.gz
      dest: /home/ubuntu/
  
  - name: List directory to debug
    shell: |
      pwd
      ls -la
      ls -la /home/ubuntu/
      ls -la /home/ubuntu/bookingapp
      ls -la /home/ubuntu/bookingapp/project

  - name: Build Docker Image
    become: true
    shell: |
      cd /home/ubuntu/bookingapp/project
      ls -la
      cat .env
      docker build -t juanvaes/bookingapp .

  - name: Push Docker Image to Docker Hub
    shell: |
      docker login -u "{{ lookup('env', 'DOCKERHUB_USERNAME') }}" -p "{{ lookup('env', 'DOCKERHUB_PW') }}"
      docker tag bookingapp:latest juanvaes/bookingapp:latest
      docker push juanvaes/bookingapp
 

  - name: Run the Docker Hub Container with Kubernetes
    become: true
    ignore_errors: yes
    shell: |
      cd /home/ubuntu/bookingapp/project
      echo "Initializing conntrack and socat..."
      apt-get install -y conntrack
      apt-get install -y socat
      echo "Initializing cluster..."
      minikube start --driver=none
      sleep 10
      kubectl get nodes
      kubectl create deployment bookingapp-deployment --image=juanvaes/bookingapp:latest
      kubectl get deployments
      export NODE_PORT=$(sudo kubectl get services/bookingapp-deployment -o go-template='{{(index .spec.ports 0).nodePort}}')
      echo NODE_PORT=$NODE_PORT
      curl $(sudo minikube ip):$NODE_PORT/index
      kubectl port-forward --address 0.0.0.0 deployment/bookingapp-deployment 80:80
